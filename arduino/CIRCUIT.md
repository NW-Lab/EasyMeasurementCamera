# 回路図詳細（Seeed XIAO SAMD21 / ESP32-S3対応）

## 基本回路

### Seeed XIAO + Neopixel 8連

```
                    Seeed XIAO SAMD21
                   ┌──────────────────┐
                   │                  │
                   │             3V3  ├─────┬─── フォトカプラ VCC
                   │                  │     │
                   │             GND  ├─────┼─── フォトカプラ GND
                   │                  │     │    Neopixel GND
                   │              D1  ├─────┴─── フォトカプラ OUT
                   │        (GPIO1)   │           (プルアップ有効)
                   │                  │
                   │              D2  ├───────── Neopixel DIN
                   │        (GPIO2)   │
                   │                  │
                   │              D3  ├────┬──── 赤色LED (オプション)
                   │        (GPIO3)   │    │
                   │                  │   LED
                   │              D4  ├────┼──── 白色LED (オプション)
                   │        (GPIO4)   │    │
                   │                  │   LED
                   │             GND  ├────┴─[220Ω]─ LED (カソード)
                   │                  │
                   │             5V   ├───────── Neopixel 5V (USB給電時)
                   │                  │
                   └──────────────────┘
```

## Neopixel 8連（WS2812B）詳細

### 接続方法

```
Neopixel 8連ストリップ
┌─────────────────────────────────────┐
│ [LED0][LED1][LED2][LED3]            │
│ [LED4][LED5][LED6][LED7]            │
│                                     │
│  DIN   5V   GND                     │
└───┬────┬────┬────────────────────────┘
    │    │    │
    │    │    └──────────── XIAO GND
    │    └───────────────── XIAO 5V (USB給電時)
    └────────────────────── XIAO D2 (GPIO2)
```

### LED配置と役割

- **LED0-3**: 赤色（トリガー用、iPhoneが検知）
- **LED4-7**: 白色（照明用、240fps撮影用）

### 電源について

**重要**: Neopixel 8連は5V動作ですが、XIAO SAMD21は3.3V動作です。

1. **USB給電時（推奨）**:
   - XIAO の 5V ピンから Neopixel に給電
   - データ信号は3.3Vだが、多くのNeopixelは認識可能

2. **データ信号レベル変換（オプション、より確実）**:
   - 74HCT245などのレベルシフタを使用
   - 3.3V → 5V に変換

3. **電流制限**:
   - 8個のLED × 最大60mA = 480mA
   - USB給電で十分（500mA）
   - 輝度を50%に設定済み（コード内）

## フォトカプラモジュール詳細

### 一般的なフォトカプラモジュール（TCRT5000など）

```
フォトカプラモジュール
┌─────────────────────────┐
│                         │
│   [赤外線LED]  [受光部]  │
│       │          │      │
│      ↓↓↓        │      │
│       │          ↓      │
│                         │
│  VCC  GND  OUT  (調整)  │
└───┬───┬────┬────────────┘
    │   │    │
    │   │    └─────── XIAO D1 (GPIO1)
    │   └──────────── XIAO GND
    └──────────────── XIAO 3V3
```

**注意**: フォトカプラは3.3V動作のものを選択してください。

### 動作原理

1. 通常時：赤外線LEDの光が受光部に届く → OUT = HIGH
2. 水滴通過時：光が遮られる → OUT = LOW
3. XIAO側でLOW信号を検知してトリガー

## オプション：個別LED（バックアップ用）

Neopixelが万が一動作しない場合のバックアップとして、個別LEDも接続可能です。

### 赤色LED（D3）

```
D3 (GPIO3) ───┬──── LED (アノード+)
              │
             LED (5mm 赤色)
              │
              └──── LED (カソード-)
                     │
                   [220Ω]
                     │
                    GND
```

### 白色LED（D4）

```
D4 (GPIO4) ───┬──── LED (アノード+)
              │
             LED (5mm 白色)
              │
              └──── LED (カソード-)
                     │
                   [220Ω]
                     │
                    GND
```

**コード内で有効化**:
```cpp
const bool ENABLE_BACKUP_LEDS = true;  // true で有効化
```

## ピン配置（Seeed XIAO SAMD21）

```
      USB
       ↓
   ┌───────┐
D0 │●     ●│ 5V
D1 │●     ●│ GND  ← フォトカプラ GND, Neopixel GND
D2 │●     ●│ 3V3  ← フォトカプラ VCC
D3 │●     ●│ D10
D4 │●     ●│ D9
D5 │●     ●│ D8
   └───────┘

使用ピン:
- D1 (GPIO1): フォトカプラ入力
- D2 (GPIO2): Neopixel データ
- D3 (GPIO3): 赤色LED（オプション）
- D4 (GPIO4): 白色LED（オプション）
```

## 電源供給

### USB給電（推奨）

最も簡単な方法。PCまたはUSB充電器から給電。

```
USB-C ──── XIAO ──┬── 5V出力 ──── Neopixel 5V
                  │
                  └── 3V3出力 ──── フォトカプラ VCC
```

### 外部電源（大規模LED使用時）

より多くのLEDを使用する場合：

```
                    XIAO
                   ┌─────────┐
5V電源 ─────────────┤ 5V      │
  (2A以上)          │         │
                   │    GND  ├─── GND (共通)
                   └─────────┘
                        │
                        └─────── Neopixel 5V
```

**注意**: 外部電源使用時は、XIAO と 外部電源の GND を共通接続してください。

## 配線のヒント

### ブレッドボード配線例

```
     a b c d e   f g h i j
   ┌─────────────────────┐
 1 │ ● ● ● ● ●   ● ● ● ● │  ← 5V レール (Neopixel用)
   ├─────────────────────┤
 2 │ ● ● ● ● ●   ● ● ● ● │
 3 │ ● ● ● ● ●   ● ● ● ● │  ← XIAO本体
 4 │ ● ● ● ● ●   ● ● ● ● │
   ├─────────────────────┤
 5 │ ● ● ● ● ●   ● ● ● ● │
 6 │ ● ● ● ● ●   ● ● ● ● │  ← Neopixel
 7 │ ● ● ● ● ●   ● ● ● ● │
   ├─────────────────────┤
 8 │ ● ● ● ● ●   ● ● ● ● │  ← GND レール
   └─────────────────────┘
```

### ジャンパーワイヤーの色分け（推奨）

- **赤**: 5V（Neopixel電源）
- **オレンジ**: 3V3（フォトカプラ電源）
- **黒**: GND（グランド）
- **黄**: データ信号（D2 → Neopixel DIN）
- **緑**: 制御信号（D1 ← フォトカプラ OUT）

## 実装例の写真説明

### 配置イメージ

```
┌─────────────────────────────────────┐
│                                     │
│  [XIAO]  ─── USB-C ─── PC/充電器    │
│     │                               │
│     ├─── [フォトカプラ]              │
│     │        │                      │
│     │        └─── 水滴検知位置       │
│     │                               │
│     └─── [Neopixel 8連] ─── 撮影領域│
│              (赤4個 + 白4個)         │
│                                     │
└─────────────────────────────────────┘
```

## Neopixelの利点

1. **配線が簡単**: 1本の信号線で8個のLEDを制御
2. **個別制御**: 各LEDの色と輝度を個別に設定可能
3. **省スペース**: 小型で扱いやすい
4. **拡張性**: 将来的にLED数を増やすことも容易

## 安全上の注意

1. **電源電圧**: XIAO SAMD21は3.3V動作、Neopixelは5V動作
2. **電流制限**: USB給電は500mA、輝度を調整して電流を抑える
3. **極性**: Neopixelの向き（DIN/DOUT）に注意
4. **静電気**: Neopixelは静電気に弱いので注意
5. **データ線**: できるだけ短く（30cm以内推奨）

## トラブルシューティング

### Neopixelが点灯しない

- 電源（5V、GND）の接続を確認
- データ線（DIN）の接続を確認
- Neopixelの向き（DIN/DOUT）を確認
- Adafruit_NeoPixelライブラリがインストールされているか確認

### Neopixelが正しく動作しない（ちらつき、色がおかしい）

- データ信号レベルの問題（3.3V → 5V）
- レベルシフタの追加を検討
- データ線を短くする
- 電源を安定化（コンデンサ追加）

### フォトカプラが反応しない

- 3.3V動作のフォトカプラを使用しているか確認
- VCC、GND、OUTの配線を確認
- シリアルモニタで信号を確認（HIGH/LOW）

### 常にトリガーされる

- フォトカプラの光軸を確認
- 環境光の影響を確認
- プルアップ抵抗の設定を確認（INPUT_PULLUP）

## 参考資料

- [Seeed XIAO SAMD21 公式ページ](https://wiki.seeedstudio.com/Seeeduino-XIAO/)
- [Adafruit NeoPixel ライブラリ](https://github.com/adafruit/Adafruit_NeoPixel)
- [WS2812B データシート](https://cdn-shop.adafruit.com/datasheets/WS2812B.pdf)
